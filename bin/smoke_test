#! /usr/bin/env ruby

ENV['BUNDLE_GEMFILE'] = File.expand_path('../Gemfile', File.dirname(__FILE__))

require 'bundler/setup'
require 'yargs'

$test_count = 0
def test(argv, msg=nil)
    puts "#{$test_count}: #{argv.inspect} #{"(#{msg})" if msg}"
    $test_count += 1
    yargs = Yargs.new(argv)
    yield yargs
end

def fail(msg)
    $stderr.puts "FAILED: #{msg}"
    exit 1
end

test(%w[--simpleflag]) { |yargs|
    fail("Couldn't parse a simple flag") unless yargs.flag('simpleflag')
}

test(%w[--split-flag]) { |yargs|
    fail("Couldn't parse a split flag") unless yargs.flag('split-flag')
}

test(%w[-single-dash-flag]) { |yargs|
    fail("Couldn't parse a single dash flag") unless yargs.flag('single-dash-flag')
}

test(%w[--simplevalue=1]) { |yargs|
    fail("Couldn't parse a simple value") unless yargs.value('simplevalue') == '1'
}

test(["--longvalue=make sure WE are R3ading @ll (harcacter5"]) { |yargs|
    fail("Couldn't parse a long value") unless yargs.value('longvalue') == 'make sure WE are R3ading @ll (harcacter5'
}

test(["--longvalue", "make sure WE are R3ading @ll (harcacter5"]) { |yargs|
    fail("Couldn't parse a long value") unless yargs.value('longvalue') == 'make sure WE are R3ading @ll (harcacter5'
}

test(%w[--space-sep-value 2]) { |yargs|
    fail("Couldn't parse a spaced separated value") unless yargs.value('space-sep-value') == '2'
}

test(%w[-single-dash-value=3]) { |yargs|
    fail("Couldn't parse a single dash value") unless yargs.value('single-dash-value') == '3'
}

test(%w[--flags-are-consumed 1]) { |yargs|
    unless yargs.flag('flags-are-consumed') && yargs.value('flags-are-consumed').nil?
        fail("Flags should be consumed when read") 
    end
}

test(%w[--values-are-consumed 1]) { |yargs|
    unless yargs.value('values-are-consumed') == '1' && !yargs.flag('values-are-consumed')
        fail("Flags should be consumed when read") 
    end
}

puts "Done! Finished without errors."
exit 0